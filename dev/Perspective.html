<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Map Detection | Alas Wiki</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="The Next Generation Game AutoScript">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.def407d0.css" as="style"><link rel="preload" href="/assets/js/app.78daa96c.js" as="script"><link rel="preload" href="/assets/js/2.af7fb78a.js" as="script"><link rel="preload" href="/assets/js/1.592cd0e6.js" as="script"><link rel="preload" href="/assets/js/11.9cba1676.js" as="script"><link rel="prefetch" href="/assets/js/10.ebf63330.js"><link rel="prefetch" href="/assets/js/12.43ccf4d1.js"><link rel="prefetch" href="/assets/js/13.b645a106.js"><link rel="prefetch" href="/assets/js/14.13e65bfb.js"><link rel="prefetch" href="/assets/js/15.3645b6ab.js"><link rel="prefetch" href="/assets/js/16.9e372e07.js"><link rel="prefetch" href="/assets/js/17.6357ee0e.js"><link rel="prefetch" href="/assets/js/18.a56add02.js"><link rel="prefetch" href="/assets/js/19.4613b0e4.js"><link rel="prefetch" href="/assets/js/20.3a45d050.js"><link rel="prefetch" href="/assets/js/21.b4491ec8.js"><link rel="prefetch" href="/assets/js/22.cfb93602.js"><link rel="prefetch" href="/assets/js/23.4e633445.js"><link rel="prefetch" href="/assets/js/24.ee46bcea.js"><link rel="prefetch" href="/assets/js/25.5277074d.js"><link rel="prefetch" href="/assets/js/26.814211c4.js"><link rel="prefetch" href="/assets/js/27.77947e8a.js"><link rel="prefetch" href="/assets/js/28.3c2ae803.js"><link rel="prefetch" href="/assets/js/29.8feb7215.js"><link rel="prefetch" href="/assets/js/3.c9cdf263.js"><link rel="prefetch" href="/assets/js/30.1dbca0e1.js"><link rel="prefetch" href="/assets/js/31.62fe9090.js"><link rel="prefetch" href="/assets/js/32.ffbcbbd8.js"><link rel="prefetch" href="/assets/js/33.419fa715.js"><link rel="prefetch" href="/assets/js/34.be138503.js"><link rel="prefetch" href="/assets/js/35.02543194.js"><link rel="prefetch" href="/assets/js/36.d34ca2d4.js"><link rel="prefetch" href="/assets/js/37.4caf7cbd.js"><link rel="prefetch" href="/assets/js/38.a96e4d9c.js"><link rel="prefetch" href="/assets/js/39.03826fec.js"><link rel="prefetch" href="/assets/js/4.baa974b4.js"><link rel="prefetch" href="/assets/js/40.5a5e0ce9.js"><link rel="prefetch" href="/assets/js/41.4f6a0496.js"><link rel="prefetch" href="/assets/js/42.6183f45f.js"><link rel="prefetch" href="/assets/js/43.efdb1d6c.js"><link rel="prefetch" href="/assets/js/44.08309fa8.js"><link rel="prefetch" href="/assets/js/45.cd150b46.js"><link rel="prefetch" href="/assets/js/46.ddffbb5c.js"><link rel="prefetch" href="/assets/js/47.0e259247.js"><link rel="prefetch" href="/assets/js/48.fdf2013b.js"><link rel="prefetch" href="/assets/js/49.9e5ab69e.js"><link rel="prefetch" href="/assets/js/5.596c3c4c.js"><link rel="prefetch" href="/assets/js/50.d300a10a.js"><link rel="prefetch" href="/assets/js/51.fc74317d.js"><link rel="prefetch" href="/assets/js/52.5032b379.js"><link rel="prefetch" href="/assets/js/53.09200c6c.js"><link rel="prefetch" href="/assets/js/54.60201a5a.js"><link rel="prefetch" href="/assets/js/55.d97fffca.js"><link rel="prefetch" href="/assets/js/56.9085dd2f.js"><link rel="prefetch" href="/assets/js/57.9f3d6151.js"><link rel="prefetch" href="/assets/js/58.c79528e6.js"><link rel="prefetch" href="/assets/js/59.c09675e8.js"><link rel="prefetch" href="/assets/js/6.6e945098.js"><link rel="prefetch" href="/assets/js/60.1e35e4ea.js"><link rel="prefetch" href="/assets/js/61.0e154a78.js"><link rel="prefetch" href="/assets/js/62.3c6d2a1e.js"><link rel="prefetch" href="/assets/js/63.b657ee9e.js"><link rel="prefetch" href="/assets/js/64.0e5b9088.js"><link rel="prefetch" href="/assets/js/7.150b3b85.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.9fd01095.js">
    <link rel="stylesheet" href="/assets/css/0.styles.def407d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Alas Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/dev/Perspective.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Develop
</a></div><div class="nav-item"><a href="https://alas.azurlane.cloud/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Official Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://alas.azurlane.cloud/demo/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Alas Demo
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/LmeSzinc/AzurLaneAutoScript/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github Page
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/Perspective.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/dev/Perspective.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/dev/Perspective.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Develop
</a></div><div class="nav-item"><a href="https://alas.azurlane.cloud/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Official Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://alas.azurlane.cloud/demo/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Alas Demo
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/LmeSzinc/AzurLaneAutoScript/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github Page
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/Perspective.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/dev/Perspective.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Develop</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/Perspective.html" aria-current="page" class="active sidebar-link">Map Detection</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/Perspective.html#one-point-perspective" class="sidebar-link">One Point Perspective</a></li><li class="sidebar-sub-header"><a href="/dev/Perspective.html#screenshot-pre-processing" class="sidebar-link">Screenshot Pre-processing</a></li><li class="sidebar-sub-header"><a href="/dev/Perspective.html#grid-detection" class="sidebar-link">Grid Detection</a></li><li class="sidebar-sub-header"><a href="/dev/Perspective.html#fitting-grid-lines" class="sidebar-link">Fitting Grid Lines</a></li><li class="sidebar-sub-header"><a href="/dev/Perspective.html#fitting-vanish-point" class="sidebar-link">Fitting Vanish Point</a></li><li class="sidebar-sub-header"><a href="/dev/Perspective.html#fitting-distant-point" class="sidebar-link">Fitting Distant Point</a></li><li class="sidebar-sub-header"><a href="/dev/Perspective.html#cleansing-grid-lines" class="sidebar-link">Cleansing Grid Lines</a></li><li class="sidebar-sub-header"><a href="/dev/Perspective.html#parsing-grid-data" class="sidebar-link">Parsing Grid Data</a></li></ul></li><li><a href="/dev/item_statistics.html" class="sidebar-link">How to do statistics on item drop rate</a></li><li><a href="/dev/debug_perspective.html" class="sidebar-link">How to debug a perspective error</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="map-detection"><a href="#map-detection" class="header-anchor">#</a> Map Detection</h1> <blockquote><p>Video tutorials (In Chinese)：</p> <p><a href="https://www.bilibili.com/video/BV1Jg411Z7PL/" target="_blank" rel="noopener noreferrer">[碧蓝航线]海图识别-从屏幕内容到海域信息(上)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.bilibili.com/video/BV1it4y1E7pz/" target="_blank" rel="noopener noreferrer">[碧蓝航线]海图识别-从屏幕内容到海域信息(下)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>Map detection is the core of an Azur lane bot. If simply using <code>template matching</code> to do the enemy detection, it will inevitably appear BOSS block by enemies. AzurLaneAutoScript (Alas), provides a better approach of map detection. In module.map, you can get full information in map, such as:</p> <div class="language- extra-class"><pre class="language-text"><code>2020-03-10 22:09:03.830 | INFO |    A  B  C  D  E  F  G  H
2020-03-10 22:09:03.830 | INFO | 1 -- ++ 2E -- -- -- -- --
2020-03-10 22:09:03.830 | INFO | 2 -- ++ ++ MY -- -- 2E --
2020-03-10 22:09:03.830 | INFO | 3 == -- FL -- -- -- 2E MY
2020-03-10 22:09:03.830 | INFO | 4 -- == -- -- -- -- ++ ++
2020-03-10 22:09:03.830 | INFO | 5 -- -- -- 2E -- 2E ++ ++
</code></pre></div><p>module.map mainly consists of the following files:</p> <ul><li>perspective.py Perspective detection</li> <li>grids.py Grid data parsing</li> <li>camera.py Camera moving</li> <li>fleet.py Fleet moving</li> <li>map.py Map logics for enemy searching</li></ul> <h2 id="one-point-perspective"><a href="#one-point-perspective" class="header-anchor">#</a> One Point Perspective</h2> <p>Before understanding how alas do map detection, we have to go through some basic knowledge of <code>one point perspective</code>. Map of Azur Lane is grid in one point perspective. Parsing perspective needs to calculate <code>vanish point</code> and <code>distant point</code>.</p> <p>In one point perspective:</p> <ul><li>the perspective of horizontal lines are still horizontal lines.</li> <li>the perspective of all vertical lines intersect at one point, called <code>vanish point</code>. The further a vanish point away from grids, the perspective of vertical lines closer to 90 degree.</li></ul> <p><img src="/assets/img/vanish_point.40a28a45.png" alt="vanish_point"></p> <ul><li>All diagonals of the grids intersect at one point, called <code>distant point</code>, The further a distant point away from grids, the grid become fatter. In fact, there are 2 distant point, the following image draws the one to the left of vanish point.</li></ul> <p><img src="/assets/img/distant_point.6dd3753e.png" alt="distant_point"></p> <h2 id="screenshot-pre-processing"><a href="#screenshot-pre-processing" class="header-anchor">#</a> Screenshot Pre-processing</h2> <p><img src="/assets/img/preprocess.e459e73f.png" alt="preprocess"></p> <p>When perspective.py gets an screenshot, function  <code>load_image</code>  do such process:</p> <ul><li>crop area of detection</li> <li>to grayscale, Using the algorithm in Photoshop, (MAX(R, G, B) + MIN(R, G, B)) // 2</li> <li>cover UI. Here use <code>overlay.png</code></li> <li>Reverse color</li></ul> <p>(Image above is before reverse, because the reversed image is too terrified to show)</p> <h2 id="grid-detection"><a href="#grid-detection" class="header-anchor">#</a> Grid Detection</h2> <h3 id="detecting-grid-lines"><a href="#detecting-grid-lines" class="header-anchor">#</a> Detecting Grid Lines</h3> <p>Grid lines are black lines with a transparency of 20%. In 720P, it has 3 to 4 pixel wide. During the period of &quot;old-UI&quot;, we simply move the image 1px and divide by the origin image to detect grid lines. White frame with transparency gradient is added in &quot;new-UI&quot;, which increase the difficulty of detection.</p> <p>Function <code>find_peaks</code> use  <code>scipy.signal.find_peaks</code> to find grid lines. <code>scipy.signal.find_peaks</code> can find peaks of given data.</p> <p>Crop image at height == 370, use following parameters:</p> <div class="language- extra-class"><pre class="language-text"><code>FIND_PEAKS_PARAMETERS = {
    'height': (150, 255 - 40),
    'width': 2,
    'prominence': 10,
    'distance': 35,
}
</code></pre></div><p><img src="/assets/img/find_peaks.eb69ce3b.png" alt="find_peaks"></p> <p>As you can see, some grid lines are not detected and has many mistake as well. Not a big deal.</p> <p>Scan every row and draw the image. (For better performance, image will be flatten to 1-D array before detection, which will reduce time cost to 1/4.)</p> <p><img src="/assets/img/peaks.ab8e68ca.png" alt="peaks"></p> <p>We gets 4 images so far, they are <code>vertical inner lines</code>, <code>horizontal inner lines</code>, <code>vertical edge lines</code>, <code>horizontal edge lines</code>. This process takes about 0.13 s on <code>I7-8700k</code> , and the full map detection process will take about 0.15 s.</p> <p>P. S. Parameters use to detect inner lines are different from edge lines. In different maps, we should use different parameters. If you are lazy, you can use the default parameters, which is for 7-2. Those parameters can be used in Chapter 7, can even be used in <code>北境序曲(event_20200227_cn) D3</code>.</p> <h2 id="fitting-grid-lines"><a href="#fitting-grid-lines" class="header-anchor">#</a> Fitting Grid Lines</h2> <p>Function <code>hough_lines</code> use  <code>cv2.HoughLines</code> to detect lines. Now we have 4 group of lines.</p> <p><img src="/assets/img/hough_lines_1.472f2f95.png" alt="hough_lines_1"></p> <p>Take <code>vertical inner lines</code> for example. There some incorrect lines.</p> <p>We create a horizontal line at the middle of image, called <code>MID_Y</code>, (When fixing vertical lines, create a vertical one), and cross  <code>vertical inner lines</code>, those crossing points are called <code>mid</code>. If the distance between two mids smaller than 3, we treat them as a group of lines, and replace them with their average. After that, we corrected the result.</p> <h2 id="fitting-vanish-point"><a href="#fitting-vanish-point" class="header-anchor">#</a> Fitting Vanish Point</h2> <p>As mention above, all vertical lines in one point perspective intersect at one point. There are errors in vertical lines, so we can't solve the equations to get that.</p> <p>Function <code>_vanish_point_value</code> , use to calculate the distance between a point and a group of lines, and use <code>scipy.optimize.brute</code> to brute-force solve the closest point to vertical lines, which is called <code>vanish point</code>. This surface shows the sum of distance from the point to the group of vertical line. In order to ignore wrong lines far away from vanish point, it uses logarithm.</p> <p><img src="/assets/img/vanish_point_distance.20b6a7fe.png" alt="vanish_point_distance"></p> <p>Still remember <code>mid</code> ? we re-link then to vanish point, and act as vertical lines. This is the 2nd correction.</p> <h2 id="fitting-distant-point"><a href="#fitting-distant-point" class="header-anchor">#</a> Fitting Distant Point</h2> <p>We intersect the corrected vertical lines and the origin horizontal lines. <code>distant point</code> and <code>canish point</code> are on the same horizontal line, so we take a point on this horizontal line, and link all intersection, get <code>oblique lines</code>. Function  <code>_distant_point_value</code> calculates the distance between the <code>mid</code> of oblique lines. Also use <code>scipy.optimize.brute</code> to brute-force solve the closet point, called <code>distant point</code>.</p> <p>This image draws the oblique lines. Although there are many mistakes, it do gets the correct point.</p> <p><img src="/assets/img/diatant_point_links.c53ad05c.png" alt="diatant_point_links"></p> <h2 id="cleansing-grid-lines"><a href="#cleansing-grid-lines" class="header-anchor">#</a> Cleansing Grid Lines</h2> <p>With the above process, we get grid lines like this. It's generally correct, but with mistakes.</p> <p><img src="/assets/img/mid_cleanse_before.57d9f0d6.png" alt="mid_cleanse_before"></p> <p>Take the <code>mid</code> of vertical lines.</p> <div class="language- extra-class"><pre class="language-text"><code>[ 185.63733413  315.65944444  441.62998244  446.89313842  573.6301653
  686.40881027  701.20376316  830.27394123  959.00511191 1087.91874026
 1220.58809477]
</code></pre></div><p>We know all grid has a same width, so theoretically, <code>mid</code> is an arithmetic progression, but with wrong members and missing members. Use a linear function <code>y = a * x + b</code> to describe that. Because of mistakes and missing, the <code>x</code> in linear function may not be the number <code>n</code> in arithmetic progression. As long as mistakes less than 10, there will have  <code>x ∈ [n - 10, n + 10]</code> .</p> <p>Then, transform the linear function as <code>b = -x * a + y</code>, and  <code>x ∈ [n - 10, n + 10]</code> . If treat <code>a</code> to be independent variable and treat <code>b</code> to be dependent variable, it's a group of lines with amount of 11 * 21. Draw them.</p> <p><img src="/assets/img/mid_cleanse_lines_with_circle.f23b4545.png" alt="mid_cleanse_lines_with_circle"></p> <p>Discover that many lines intersect at where the orange circle pointed out, we call them <code>coincident point</code>. Those incorrect <code>mid</code> from incorrect lines can't intersect there, and get deleted.</p> <p>Use  <code>scipy.optimize.brute</code> to brute-force solve the coordinate of the best <code>coincident point</code>.</p> <div class="language- extra-class"><pre class="language-text"><code>[-201.33197146  129.0958336]
</code></pre></div><p>So the linear function is <code>y = 129.0958336 * x - 201.33197146</code> .</p> <blockquote><p>When calculating distance to the lines, it uses this function</p> <div class="language- extra-class"><pre class="language-text"><code>distance = 1 / (1 + np.exp(9 / distance) / distance)
</code></pre></div><p>This function makes it less effect by lines far away, encourage optimizer to choose the local minimum.</p> <p><img src="/assets/img/mid_cleanse_function.ef172eda.png" alt="mid_cleanse_function"></p></blockquote> <blockquote><p>How to cleanse horizontal lines?</p> <p>Make any line through <code>distant point</code>, link intersections and  <code>vanish point</code> . This finish a map relation from horizontal lines to vertical lines. When cleanse finished, do a reversed process.</p> <p><img src="/assets/img/mid_cleanse_convert.385968c8.png" alt="mid_cleanse_convert"></p></blockquote> <p>At last, generate <code>mid</code>, and crop it with the edge of map and screen. Missing <code>mid</code> get filled now. Re-link <code>mid</code> to vanish point, and the cleansing of grid lines is finished.</p> <p>Draw results:</p> <p><img src="/assets/img/mid_cleanse_after-1584008112022.4ea4ee59.png" alt="mid_cleanse_after"></p> <h1 id="grid-cropping"><a href="#grid-cropping" class="header-anchor">#</a> Grid Cropping</h1> <p>In fact, shipgrils, enemies, mystery are images fixed on grid center. They are scaled because of perspective.</p> <p>P. S. They are scaled only, but not perspective transform. Only red border and yellow border on the ground are perspective transformed.</p> <p><img src="/assets/img/crop_basic.edc6b828.png" alt="crop_basic"></p> <p>In <code>grid_predictor.py</code>, provides function  <code>get_relative_image</code> , which do crops according to grid center, and rescale to given shape. Now we can simply use template matching.</p> <div class="language- extra-class"><pre class="language-text"><code>from PIL import Image
from module.config.config import cfg
i = Image.open(file)
grids = Grids(i, cfg)
out = Image.new('RGB', tuple((grids.shape + 1) * 105 - 5))
for loca, grid in grids.grids.items():
    image = grid.get_relative_image(
    	(-0.415 - 0.7, -0.62 - 0.7, -0.415, -0.62), output_shape=(100, 100))
    out.paste(image, tuple(np.array(loca) * 105))
out
</code></pre></div><p><img src="/assets/img/crop_scale.b188119b.png" alt="crop_scale"></p> <h2 id="parsing-grid-data"><a href="#parsing-grid-data" class="header-anchor">#</a> Parsing Grid Data</h2> <p>To be continued.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/dev/item_statistics.html">
        How to do statistics on item drop rate
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.78daa96c.js" defer></script><script src="/assets/js/2.af7fb78a.js" defer></script><script src="/assets/js/1.592cd0e6.js" defer></script><script src="/assets/js/11.9cba1676.js" defer></script>
  </body>
</html>
